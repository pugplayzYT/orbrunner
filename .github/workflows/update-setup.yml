name: Update Setup Docs

on:
  push:
    branches: ["main", "master"]

jobs:
  update-setup:
    name: Sync setup.md version
    runs-on: ubuntu-latest
    # Skip bot commits from this very workflow to avoid infinite loops
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get current version
        run: |
          VERSION=$(grep -v '^#' src/main/resources/update_logs/index.txt | grep '\S' | tail -n 1 | sed 's/\.md//')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Found version: $VERSION"

      - name: Update setup.md
        run: |
          python3 - <<'PYEOF'
          import re, os

          version = os.environ["VERSION"]

          with open("setup.md", "r") as f:
              content = f.read()

          # Update the version marker
          content = re.sub(
              r"<!-- LATEST_VERSION -->.*?<!-- /LATEST_VERSION -->",
              f"<!-- LATEST_VERSION -->{version}<!-- /LATEST_VERSION -->",
              content,
          )

          # Update versioned game JAR download links
          # Matches: releases/download/vX.X/orbrunner-vX.X.jar
          content = re.sub(
              r"(releases/download/)v[\d.]+(/orbrunner-)v[\d.]+(\.jar)",
              rf"\g<1>{version}\g<2>{version}\g<3>",
              content,
          )

          with open("setup.md", "w") as f:
              f.write(content)

          print(f"setup.md updated to {version}")
          PYEOF
        env:
          VERSION: ${{ env.VERSION }}

      - name: Commit if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if ! git diff --quiet setup.md; then
            git add setup.md
            git commit -m "docs: sync setup.md to ${{ env.VERSION }} [skip ci]"
            git push
          else
            echo "setup.md already up to date"
          fi
